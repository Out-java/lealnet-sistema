<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Sistema Provedor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <style>
      body {
        font-family: Arial;
        background: #f4f6f9;
        padding: 20px;
      }
      .container {
        max-width: 1000px;
        margin: auto;
      }
      input,
      select,
      textarea,
      button {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
      }
      button {
        cursor: pointer;
      }
      .card {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .pendente {
        border-left: 6px solid #ff4d4d;
      }
      .andamento {
        border-left: 6px solid #ffc107;
      }
      .finalizado {
        border-left: 6px solid #28a745;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>Login</h2>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="senha" placeholder="Senha" />
      <button onclick="login()">Entrar</button>

      <hr />

      <div id="sistema" class="hidden">
        <h2>Novo Atendimento</h2>

        <select id="tipo">
          <option value="manutencao">Manutenção</option>
          <option value="instalacao">Instalação</option>
          <option value="retirada">Retirada</option>
        </select>

        <input type="text" id="cliente" placeholder="Nome do cliente" />
        <input type="text" id="telefone" placeholder="Telefone" />
        <input type="text" id="endereco" placeholder="Endereço" />

        <select id="status">
          <option value="pendente">Pendente</option>
          <option value="andamento">Em andamento</option>
          <option value="finalizado">Finalizado</option>
        </select>

        <textarea id="obs" placeholder="Observações"></textarea>

        <input type="file" id="foto" />

        <button onclick="criar()">Salvar Atendimento</button>

        <hr />

        <h2>Atendimentos</h2>
        <div id="lista"></div>
      </div>
    </div>

    <script>
      const supabaseCliente = window.supabase.createClient(
        "https://ntgscmhtcrpkayrxseec.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50Z3NjbWh0Y3Jwa2F5cnhzZWVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNDg3OTYsImV4cCI6MjA4NzYyNDc5Nn0.xk6yE12CUh9UoZGKMy9iZmVnCE_vI1eudrSRXClXKkw",
      );

      let usuario = null;

      async function login() {
        const emailInput = document.getElementById("email").value;
        const senhaInput = document.getElementById("senha").value;

        if (!emailInput || !senhaInput) {
          return alert("Por favor, preencha email e senha.");
        }

        const { data, error } = await supabaseCliente.auth.signInWithPassword({
          email: emailInput,
          password: senhaInput,
        });

        if (error) return alert("Erro no login: " + error.message);

        usuario = data.user;
        document.getElementById("sistema").classList.remove("hidden");
        carregar();
      }

      async function criar() {
        if (!usuario) return alert("Faça login primeiro");

        // Capturando os valores de forma segura
        const tipoInput = document.getElementById("tipo").value;
        const clienteInput = document.getElementById("cliente").value;
        const telefoneInput = document.getElementById("telefone").value;
        const enderecoInput = document.getElementById("endereco").value;
        const statusInput = document.getElementById("status").value;
        const obsInput = document.getElementById("obs").value;
        const fotoInput = document.getElementById("foto");

        if (!clienteInput) return alert("O nome do cliente é obrigatório.");

        const { data, error } = await supabaseCliente
          .from("atendimentos")
          .insert([
            {
              tipo: tipoInput,
              cliente_nome: clienteInput,
              cliente_telefone: telefoneInput,
              endereco: enderecoInput,
              status: statusInput,
              observacoes: obsInput,
              criado_por: usuario.id,
            },
          ])
          .select();

        if (error) return alert("Erro ao salvar atendimento: " + error.message);

        const atendimentoId = data[0].id;
        const file = fotoInput.files[0];

        if (file) {
          const { data: uploadData, error: uploadError } =
            await supabaseCliente.storage
              .from("atendimentos")
              .upload(`${atendimentoId}/${file.name}`, file);

          if (uploadError) {
            alert(
              "Atendimento criado, mas houve um erro ao enviar a foto: " +
                uploadError.message,
            );
          } else {
            const { error: anexoError } = await supabaseCliente
              .from("anexos")
              .insert([
                {
                  atendimento_id: atendimentoId,
                  url: uploadData.path,
                  nome_arquivo: file.name,
                },
              ]);

            if (anexoError)
              console.error("Erro ao registrar anexo no banco: ", anexoError);
          }
        }

        // Limpar os campos após salvar
        document.getElementById("cliente").value = "";
        document.getElementById("telefone").value = "";
        document.getElementById("endereco").value = "";
        document.getElementById("obs").value = "";
        document.getElementById("foto").value = "";

        alert("Atendimento salvo com sucesso!");
        carregar();
      }

      async function carregar() {
        const { data, error } = await supabaseCliente
          .from("atendimentos")
          .select("*")
          .order("data_abertura", { ascending: false });

        if (error) {
          console.error("Erro ao carregar atendimentos:", error);
          return;
        }

        const lista = document.getElementById("lista");
        lista.innerHTML = "";

        data.forEach((a) => {
          lista.innerHTML += `
      <div class="card ${a.status}">
        <strong>${a.tipo.toUpperCase()}</strong><br>
        Cliente: ${a.cliente_nome}<br>
        Status: ${a.status}<br>
        <p>${a.observacoes || ""}</p>
      </div>
    `;
        });
      }
    </script>
  </body>
</html>
